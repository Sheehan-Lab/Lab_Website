---
import Layout from '../layouts/Layout.astro';
import { getPageContent, getFeaturedPublications, urlFor } from '../utils/sanity';

// Fetch home page content and featured publications from Sanity CMS
let pageContent = null;
let featuredPublications = [];
let error = null;

try {
  [pageContent, featuredPublications] = await Promise.all([
    getPageContent('home'),
    getFeaturedPublications()
  ]);
} catch (e) {
  error = e.message;
  console.error('Error fetching home page content:', e);
}

// Fallback content if CMS is not configured
const fallbackContent = {
  title: "Sheehan Lab",
  subtitle: "Advancing Sickle Cell Disease Research",
  content: [
    {
      _type: 'block',
      children: [{ text: "Welcome to the Sheehan Lab at Emory University School of Medicine. We are dedicated to improving the lives of individuals with sickle cell disease through innovative research and therapeutic development." }]
    }
  ]
};

const displayContent = pageContent || fallbackContent;

// Helper function to render portable text as simple HTML
function renderPortableText(blocks) {
  if (!blocks) return '';
  
  return blocks.map(block => {
    if (block._type === 'block') {
      const children = block.children?.map(child => {
        let text = child.text || '';
        if (child.marks?.includes('strong')) text = `<strong>${text}</strong>`;
        if (child.marks?.includes('em')) text = `<em>${text}</em>`;
        return text;
      }).join('') || '';
      
      switch (block.style) {
        case 'h1': return `<h2>${children}</h2>`;
        case 'h2': return `<h3>${children}</h3>`;
        case 'h3': return `<h4>${children}</h4>`;
        default: return `<p>${children}</p>`;
      }
    }
    return '';
  }).join('');
}
---

<Layout title={`${displayContent.title || 'Home'} | Sheehan Lab`}>
  <main>
    <section class="hero">
      <div class="hero-background">
        {displayContent.heroImage ? (
          <img 
            src={urlFor(displayContent.heroImage).width(1920).height(1080).quality(85).url()} 
            alt={displayContent.title}
            class="hero-image"
          />
        ) : (
          <div class="hero-pattern"></div>
        )}
        <div class="hero-overlay"></div>
      </div>
      <div class="hero-content">
        <div class="container">
          <h1>{displayContent.title}</h1>
          {displayContent.subtitle && <p class="hero-subtitle">{displayContent.subtitle}</p>}
          <div class="hero-actions">
            <a href="/research-cms" class="cta-button primary">Our Research</a>
            <a href="/team-cms" class="cta-button secondary">Meet the Team</a>
          </div>
        </div>
      </div>
    </section>

    {error && (
      <section class="info-section">
        <div class="container">
          <div class="info-message">
            <h2>ðŸ”§ CMS Configuration</h2>
            <p>This page is powered by Sanity CMS. Configure the CMS to customize this content.</p>
            <details>
              <summary>Technical details</summary>
              <p>{error}</p>
            </details>
          </div>
        </div>
      </section>
    )}

    <section class="content-section">
      <div class="container">
        <div class="content-grid">
          <div class="main-content">
            {displayContent.content && (
              <div class="content-text" set:html={renderPortableText(displayContent.content)} />
            )}
          </div>
          <div class="sidebar">
            <div class="quick-links">
              <h3>Quick Links</h3>
              <ul>
                <li><a href="/research-cms">Research Areas</a></li>
                <li><a href="/publications-cms">Publications</a></li>
                <li><a href="/team-cms">Our Team</a></li>
                <li><a href="/positions">Open Positions</a></li>
                <li><a href="/contact">Contact Us</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    {featuredPublications.length > 0 && (
      <section class="featured-section">
        <div class="container">
          <h2>Latest Research</h2>
          <div class="featured-grid">
            {featuredPublications.slice(0, 3).map((pub) => (
              <article class="featured-publication">
                <h3>{pub.title}</h3>
                <p class="authors">{pub.authors.slice(0, 3).join(', ')}{pub.authors.length > 3 ? ', et al.' : ''}</p>
                <p class="journal">{pub.journal} ({pub.year})</p>
                <div class="publication-links">
                  {pub.doi && (
                    <a href={`https://doi.org/${pub.doi}`} target="_blank" rel="noopener noreferrer" class="link-button">
                      DOI
                    </a>
                  )}
                  {pub.pmid && (
                    <a href={`https://pubmed.ncbi.nlm.nih.gov/${pub.pmid}/`} target="_blank" rel="noopener noreferrer" class="link-button">
                      PubMed
                    </a>
                  )}
                </div>
              </article>
            ))}
          </div>
          <div class="section-footer">
            <a href="/publications-cms" class="cta-link">View All Publications â†’</a>
          </div>
        </div>
      </section>
    )}

    <section class="research-preview">
      <div class="container">
        <h2>Our Research Focus</h2>
        <div class="research-areas">
          <div class="research-card">
            <div class="research-icon">ðŸ§¬</div>
            <h3>Gene Therapy</h3>
            <p>Developing innovative gene editing approaches for sickle cell disease treatment.</p>
          </div>
          <div class="research-card">
            <div class="research-icon">ðŸ”¬</div>
            <h3>HbF Induction</h3>
            <p>Investigating fetal hemoglobin induction as a therapeutic strategy.</p>
          </div>
          <div class="research-card">
            <div class="research-icon">ðŸ©¸</div>
            <h3>RBC Function</h3>
            <p>Studying red blood cell mechanics and function using microfluidics.</p>
          </div>
          <div class="research-card">
            <div class="research-icon">ðŸ§ª</div>
            <h3>Drug Development</h3>
            <p>Discovering and validating novel therapeutic compounds.</p>
          </div>
        </div>
        <div class="section-footer">
          <a href="/research-cms" class="cta-link">Learn More About Our Research â†’</a>
        </div>
      </div>
    </section>
  </main>

  <style>
    .hero {
      position: relative;
      height: 100vh;
      min-height: 600px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .hero-background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    .hero-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .hero-pattern {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--emory-primary) 0%, #001133 100%);
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    .hero-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 33, 105, 0.7);
      z-index: 2;
    }

    .hero-content {
      position: relative;
      z-index: 3;
      text-align: center;
      color: white;
      width: 100%;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.25rem;
    }

    .hero h1 {
      font-size: 4rem;
      margin-bottom: 1rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      animation: fadeInUp 1s ease-out;
    }

    .hero-subtitle {
      font-size: 1.5rem;
      margin-bottom: 2rem;
      opacity: 0.9;
      animation: fadeInUp 1s ease-out 0.2s both;
    }

    .hero-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      animation: fadeInUp 1s ease-out 0.4s both;
    }

    .cta-button {
      display: inline-block;
      padding: 1rem 2rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .cta-button.primary {
      background: var(--emory-secondary);
      color: white;
    }

    .cta-button.primary:hover {
      background: #d4a574;
      transform: translateY(-2px);
    }

    .cta-button.secondary {
      background: transparent;
      color: white;
      border: 2px solid white;
    }

    .cta-button.secondary:hover {
      background: white;
      color: var(--emory-primary);
    }

    .info-section {
      padding: 2rem 0;
      background: #f0f9ff;
      border-bottom: 1px solid #e0f2fe;
    }

    .info-message {
      text-align: center;
      color: #0c4a6e;
    }

    .content-section {
      padding: 4rem 0;
      background: white;
    }

    .content-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 3rem;
      align-items: start;
    }

    .content-text {
      font-size: 1.1rem;
      line-height: 1.7;
      color: #374151;
    }

    .content-text h2 {
      color: var(--emory-primary);
      margin: 2rem 0 1rem;
    }

    .content-text h3 {
      color: var(--emory-secondary);
      margin: 1.5rem 0 0.75rem;
    }

    .content-text p {
      margin-bottom: 1.5rem;
    }

    .sidebar {
      background: #f8fafc;
      border-radius: 12px;
      padding: 2rem;
      height: fit-content;
    }

    .quick-links h3 {
      color: var(--emory-primary);
      margin-bottom: 1rem;
      font-size: 1.25rem;
    }

    .quick-links ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .quick-links li {
      margin-bottom: 0.75rem;
    }

    .quick-links a {
      color: #4a5568;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .quick-links a:hover {
      color: var(--emory-primary);
    }

    .featured-section {
      padding: 4rem 0;
      background: #f8fafc;
    }

    .featured-section h2 {
      text-align: center;
      color: var(--emory-primary);
      margin-bottom: 3rem;
      font-size: 2.5rem;
    }

    .featured-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .featured-publication {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 12px rgba(0, 33, 105, 0.06);
      transition: transform 0.3s ease;
    }

    .featured-publication:hover {
      transform: translateY(-4px);
    }

    .featured-publication h3 {
      color: var(--emory-primary);
      margin-bottom: 1rem;
      font-size: 1.25rem;
      line-height: 1.4;
    }

    .authors {
      color: #6b7280;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .journal {
      color: var(--emory-secondary);
      font-style: italic;
      margin-bottom: 1rem;
    }

    .publication-links {
      display: flex;
      gap: 0.75rem;
    }

    .link-button {
      padding: 0.5rem 1rem;
      background: var(--emory-primary);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.85rem;
      transition: background-color 0.3s ease;
    }

    .link-button:hover {
      background: var(--emory-secondary);
    }

    .research-preview {
      padding: 4rem 0;
      background: white;
    }

    .research-preview h2 {
      text-align: center;
      color: var(--emory-primary);
      margin-bottom: 3rem;
      font-size: 2.5rem;
    }

    .research-areas {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .research-card {
      text-align: center;
      padding: 2rem;
      background: #f8fafc;
      border-radius: 12px;
      transition: transform 0.3s ease;
    }

    .research-card:hover {
      transform: translateY(-4px);
    }

    .research-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .research-card h3 {
      color: var(--emory-primary);
      margin-bottom: 1rem;
    }

    .research-card p {
      color: #6b7280;
      line-height: 1.6;
    }

    .section-footer {
      text-align: center;
      margin-top: 2rem;
    }

    .cta-link {
      color: var(--emory-primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 1.1rem;
      transition: color 0.3s ease;
    }

    .cta-link:hover {
      color: var(--emory-secondary);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .hero h1 {
        font-size: 2.5rem;
      }

      .hero-subtitle {
        font-size: 1.25rem;
      }

      .hero-actions {
        flex-direction: column;
        align-items: center;
      }

      .content-grid {
        grid-template-columns: 1fr;
        gap: 2rem;
      }

      .featured-grid {
        grid-template-columns: 1fr;
      }

      .research-areas {
        grid-template-columns: 1fr;
      }
    }

    details {
      margin-top: 1rem;
    }

    summary {
      cursor: pointer;
      color: #0284c7;
    }

    details p {
      margin-top: 0.5rem;
      padding: 1rem;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.9rem;
    }
  </style>
</Layout> 