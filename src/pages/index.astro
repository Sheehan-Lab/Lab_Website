---
import Layout from '../layouts/Layout.astro';
import PhotoGallery from '../components/PhotoGallery.astro';
import { getPageContent, getFeaturedPublications, getGallery, urlFor } from '../utils/sanity';
import { PortableText } from 'astro-portabletext';

// Fetch home page content, featured publications, and gallery from Sanity CMS
let pageContent = null;
let featuredPublications = [];
let labLifeGallery = null;
let error = null;

try {
  [pageContent, featuredPublications, labLifeGallery] = await Promise.all([
    getPageContent('home'),
    getFeaturedPublications(),
    getGallery('lab-life')
  ]);
} catch (e) {
  error = e.message;
  console.error('Error fetching home page data:', e);
}

const displayContent = pageContent || {};
const heroImageUrl = displayContent.heroImage 
  ? urlFor(displayContent.heroImage).url() 
  : '/images/lab-background.jpg';

const hasNewContent = displayContent.mission || (displayContent.researchHighlights && displayContent.researchHighlights.length > 0);
---

<Layout title={`${displayContent.title || 'Home'} | Sheehan Lab`}>
  <main>
    <section class="hero" style={`background-image: linear-gradient(rgba(0, 40, 120, 0.85), rgba(0, 20, 60, 0.9)), url(${heroImageUrl});`}>
      <div class="hero-content">
        <h1>{displayContent.title || 'Sheehan Lab'}</h1>
        <p class="subtitle">{displayContent.subtitle || 'Advancing Sickle Cell Disease Research and Treatment'}</p>
        <div class="hero-buttons">
          <a href="/research" class="button explore-research-btn">Explore Our Research</a>
          <a href="/publications" class="button view-publications-btn">View Publications</a>
        </div>
      </div>
    </section>

    {hasNewContent ? (
      <>
        {displayContent.mission && (
          <section class="mission">
            <div class="container">
              <h2>Our Mission</h2>
              <p>{displayContent.mission}</p>
            </div>
          </section>
        )}
        {displayContent.researchHighlights && displayContent.researchHighlights.length > 0 && (
          <section class="research-highlights">
            <div class="container">
              <h2>Research Focus</h2>
              <div class="highlight-grid">
                {displayContent.researchHighlights.map(highlight => (
                  <div class="highlight-card">
                    {highlight.icon && <div class="card-icon">{highlight.icon}</div>}
                    <h3>{highlight.title}</h3>
                    <p>{highlight.text}</p>
                  </div>
                ))}
              </div>
            </div>
          </section>
        )}
      </>
    ) : (
      displayContent.content && (
        <section class="page-content">
          <div class="container">
            <PortableText value={displayContent.content} />
          </div>
        </section>
      )
    )}
    
    {featuredPublications.length > 0 && (
      <section class="latest-updates">
        <div class="container">
          <h2>Latest Research</h2>
          <div class="updates-content">
            {featuredPublications.slice(0, 1).map((pub) => (
              <article class="latest-publication">
                <h3>{pub.title}</h3>
                <p class="authors">{pub.authors.slice(0, 3).join(', ')}{pub.authors.length > 3 ? ', et al.' : ''}</p>
                <p class="journal">{pub.journal} ({pub.year})</p>
                <div class="publication-links">
                  {pub.doi && (
                    <a href={`https://doi.org/${pub.doi}`} target="_blank" rel="noopener noreferrer" class="link-button">
                      DOI
                    </a>
                  )}
                  {pub.pmid && (
                    <a href={`https://pubmed.ncbi.nlm.nih.gov/${pub.pmid}/`} target="_blank" rel="noopener noreferrer" class="link-button">
                      PubMed
                    </a>
                  )}
                </div>
              </article>
            ))}
          </div>
           <div class="section-footer">
            <a href="/publications" class="cta-link">View All Publications â†’</a>
          </div>
        </div>
      </section>
    )}

    {labLifeGallery && labLifeGallery.photos && (
      <PhotoGallery 
        photos={labLifeGallery.photos}
        title={labLifeGallery.title}
        description={labLifeGallery.description}
      />
    )}

  </main>

<style>
/* Reset and Base Styles */
:root {
  --emory-primary: #002878;
  --emory-secondary: #00A3E0;
  --emory-accent: #f2a900;
  --background-light: #f8fafc;
  --text-dark: #2d3748;
  --text-light: #718096;
  --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}
/* Hero Section */
.hero {
  background-position: center;
  background-size: cover;
  background-repeat: no-repeat;
  height: 70vh;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  color: white;
  padding: 0 1.25rem;
  margin-top: 60px; /* Adjust for fixed navbar */
}
.hero-content h1 { font-size: 3.5rem; margin-bottom: 1rem; }
.hero-content .subtitle { font-size: 1.25rem; opacity: 0.9; margin-bottom: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;}
.hero-buttons .button { margin: 0 0.5rem; padding: 0.8rem 1.5rem; border-radius: 6px; text-decoration: none; transition: all 0.3s ease; font-weight: 500; }
.explore-research-btn { background-color: var(--emory-accent); color: var(--emory-primary); border: 1px solid var(--emory-accent); }
.explore-research-btn:hover { background-color: #ffbe33; transform: translateY(-2px); }
.view-publications-btn { background-color: transparent; border: 1px solid white; color: white; }
.view-publications-btn:hover { background-color: rgba(255, 255, 255, 0.1); transform: translateY(-2px); }

.page-content {
  padding: 4rem 1.25rem;
  background: white;
}

/* Portable Text Component Styles injected globally */
.page-content h2 {
  font-size: 2.25rem;
  color: var(--emory-primary);
  margin-bottom: 1.5rem;
  text-align: center;
}
.page-content p {
  font-size: 1.1rem;
  line-height: 1.7;
  color: var(--text-dark);
  max-width: 800px;
  margin: 0 auto 2rem auto;
  text-align: center;
}
.page-content .highlight-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 2rem;
  margin-top: 3rem;
  text-align: left;
}
.page-content .highlight-card {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: var(--card-shadow);
  text-align: center;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.page-content .highlight-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
}
.page-content .card-icon {
  font-size: 2.5rem;
  margin-bottom: 1rem;
  color: var(--emory-secondary);
}
.page-content .highlight-card h3 {
  font-size: 1.25rem;
  color: var(--emory-primary);
  margin-bottom: 0.75rem;
}
.page-content .highlight-card p {
  font-size: 1rem;
  color: var(--text-light);
  line-height: 1.6;
  text-align: center;
}

/* Latest Updates Section */
.latest-updates { padding: 4rem 1.25rem; background: white; }
.updates-content { max-width: 800px; margin: 3rem auto 0; }
.latest-publication { border: 1px solid #e2e8f0; padding: 2rem; border-radius: 12px; background: #f8fafc; }
.latest-publication h3 { font-size: 1.4rem; color: var(--emory-primary); margin-bottom: 0.75rem; }
.latest-publication .authors { font-style: italic; color: var(--text-light); margin-bottom: 1rem; }
.latest-publication .journal { font-weight: 500; color: var(--text-dark); }
.publication-links { margin-top: 1.5rem; display: flex; gap: 1rem; }
.link-button { background-color: var(--emory-secondary); color: white; padding: 0.6rem 1.2rem; border-radius: 6px; text-decoration: none; transition: background-color 0.3s ease; }
.link-button:hover { background-color: var(--emory-primary); }

.section-footer { text-align: center; margin-top: 2rem; }
.cta-link { color: var(--emory-secondary); text-decoration: none; font-weight: 500; }
.cta-link:hover { text-decoration: underline; }

/* Mission Section */
.mission { padding: 4rem 1.25rem; background: white; text-align: center; }
.container { max-width: 900px; margin: 0 auto; }
.mission h2, .research-highlights h2, .latest-updates h2 { font-size: 2.25rem; color: var(--emory-primary); margin-bottom: 1rem; text-align: center; }
.mission p { font-size: 1.1rem; line-height: 1.7; color: var(--text-dark); max-width: 800px; margin: 0 auto; }

/* Research Highlights Section */
.research-highlights { padding: 4rem 1.25rem; background: var(--background-light); }
.highlight-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-top: 3rem; }
.highlight-card { background: white; padding: 2rem; border-radius: 12px; box-shadow: var(--card-shadow); text-align: center; transition: transform 0.3s ease, box-shadow 0.3s ease; }
.highlight-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
.card-icon { font-size: 2.5rem; margin-bottom: 1rem; color: var(--emory-secondary); }
.highlight-card h3 { font-size: 1.25rem; color: var(--emory-primary); margin-bottom: 0.75rem; }
.highlight-card p { font-size: 1rem; color: var(--text-light); line-height: 1.6; }
</style>
</Layout> 