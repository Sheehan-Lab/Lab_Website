---
import Layout from '../layouts/Layout.astro';
import { getResearchAreas, urlFor } from '../utils/sanity';
import {PortableText} from 'astro-portabletext';

// Fetch research areas from Sanity CMS
let researchAreas = [];
let error = null;

try {
  researchAreas = await getResearchAreas();
} catch (e) {
  error = e.message;
  console.error('Error fetching research areas:', e);
}

// Helper function to render portable text as simple HTML
function renderPortableText(blocks) {
  if (!blocks) return '';
  
  return blocks.map(block => {
    if (block._type === 'block') {
      const children = block.children?.map(child => {
        let text = child.text || '';
        if (child.marks?.includes('strong')) text = `<strong>${text}</strong>`;
        if (child.marks?.includes('em')) text = `<em>${text}</em>`;
        return text;
      }).join('') || '';
      
      switch (block.style) {
        case 'h2': return `<h3>${children}</h3>`;
        case 'h3': return `<h4>${children}</h4>`;
        default: return `<p>${children}</p>`;
      }
    }
    return '';
  }).join('');
}
---

<Layout title="Research | Sheehan Lab">
  <main>
    <section class="page-header">
      <div class="container">
        <h1>Our Research</h1>
        <p>The Sheehan Lab is dedicated to advancing understanding and treatment of sickle cell disease through innovative approaches. Our research spans multiple areas including HbF induction, xenograft models, gene editing, alloimmunization, and microfluidics, all aimed at improving patient outcomes.</p>
      </div>
    </section>

    <div class="research-nav-wrapper">
      <aside class="research-nav">
        <nav>
          <ul>
            {researchAreas.map(area => (
              <li><a href={`#${area.slug.current}`}>{area.title}</a></li>
            ))}
          </ul>
        </nav>
      </aside>

      <div class="research-content-wrapper">
        <div class="section-divider"></div>

        {error ? (
          <section class="error-section">
            <div class="container">
              <div class="error-message">
                <h2>ðŸ”§ Unable to load research data</h2>
                <p>Please ensure the Sanity CMS is properly configured.</p>
                <details><summary>Technical details</summary><p>{error}</p></details>
              </div>
            </div>
          </section>
        ) : researchAreas.map((area, index) => (
          <>
            <section id={area.slug.current} class={`research-area ${index % 2 !== 0 ? 'alternate' : ''}`}>
              <div class="container">
                <div class="research-content">
                  <div class="text-content">
                    <h2>{area.title}</h2>
                    {area.summary && <p class="summary">{area.summary}</p>}
                    {area.description && <div class="description"><PortableText value={area.description} /></div>}
                    {area.highlights && area.highlights.length > 0 && (
                        <ul class="research-highlights">
                            {area.highlights.map(highlight => <li>{highlight}</li>)}
                        </ul>
                    )}
                  </div>
                  <div class="image-gallery">
                    {area.primaryImage && (
                        <div class="image-container primary-image">
                            <img src={urlFor(area.primaryImage).width(600).url()} alt={area.title} />
                        </div>
                    )}
                    {area.secondaryImage && (
                        <div class="image-container secondary-image">
                            <img src={urlFor(area.secondaryImage).width(400).url()} alt={`${area.title} secondary image`} />
                        </div>
                    )}
                  </div>
                </div>
              </div>
            </section>
            {index < researchAreas.length - 1 && <div class="section-divider"></div>}
          </>
        ))}
      </div>
    </div>
  </main>

  <style is:global>
    :root {
      --emory-primary: #002878;
      --emory-secondary: #00A3E0;
    }
    .page-header {
      background: var(--emory-primary);
      color: white;
      padding: 4rem 0 2.5rem;
      margin-top: 60px;
      text-align: center;
    }
    .page-header h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    .page-header p {
      max-width: 800px;
      margin: 0 auto;
      font-size: 1rem;
      padding: 0 1rem;
      line-height: 1.6;
    }
    .research-nav-wrapper {
      display: flex;
    }
    .research-content-wrapper {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
    }
    .research-nav {
      width: 240px;
      padding: 2rem 1rem;
      position: sticky;
      top: 80px;
      height: calc(100vh - 80px);
      overflow-y: auto;
      align-self: flex-start;
      display: none;
    }
    @media (min-width: 1280px) {
      .research-nav {
        display: block;
      }
      .research-content-wrapper {
        width: calc(100% - 240px);
      }
    }
    .research-nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .research-nav li {
      margin-bottom: 0.5rem;
    }
    .research-nav a {
      display: block;
      padding: 0.5rem 0.75rem;
      color: #4a5568;
      text-decoration: none;
      border-radius: 4px;
      transition: all 0.2s ease;
      border-left: 2px solid transparent;
      font-weight: 500;
      font-size: 0.9rem;
    }
    .research-nav a:hover {
      background-color: rgba(1, 33, 105, 0.05);
      color: var(--emory-primary);
    }
    .research-area {
      padding: 4rem 0;
    }
    .research-area.alternate {
      background-color: #f8fafc;
    }
    .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 1.5rem;
    }
    .research-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 3rem;
      align-items: center;
    }
    .alternate .research-content {
      grid-template-columns: 1fr 2fr;
    }
    .alternate .text-content {
      order: 2;
    }
    .text-content h2 {
      font-size: 1.8rem;
      color: var(--emory-primary);
      margin-bottom: 1.5rem;
    }
    .text-content .summary {
        font-style: italic;
        color: #4a5568;
        margin-bottom: 1.5rem;
    }
    .text-content .description p {
        margin-bottom: 1rem;
        line-height: 1.7;
    }
    .research-highlights {
      list-style-type: disc;
      padding-left: 1.5rem;
      margin-top: 1.5rem;
    }
    .research-highlights li {
      margin-bottom: 0.75rem;
    }
    .image-gallery {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .image-container img {
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .section-divider {
      border-bottom: 1px solid #e2e8f0;
      margin: 0 auto;
      max-width: 1100px;
    }
    .error-section {
      padding: 4rem 0;
    }
    .error-message {
      background: #fff5f5;
      color: #c53030;
      border: 1px solid #fed7d7;
      padding: 2rem;
      border-radius: 8px;
      text-align: center;
    }
  </style>
</Layout> 