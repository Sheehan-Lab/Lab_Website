---
import Layout from '../layouts/Layout.astro';
import { getResearchAreas, urlFor } from '../utils/sanity';

// Fetch research areas from Sanity CMS
let researchAreas = [];
let error = null;

try {
  researchAreas = await getResearchAreas();
} catch (e) {
  error = e.message;
  console.error('Error fetching research areas:', e);
}

// Helper function to render portable text as simple HTML
function renderPortableText(blocks) {
  if (!blocks) return '';
  
  return blocks.map(block => {
    if (block._type === 'block') {
      const children = block.children?.map(child => {
        let text = child.text || '';
        if (child.marks?.includes('strong')) text = `<strong>${text}</strong>`;
        if (child.marks?.includes('em')) text = `<em>${text}</em>`;
        return text;
      }).join('') || '';
      
      switch (block.style) {
        case 'h2': return `<h3>${children}</h3>`;
        case 'h3': return `<h4>${children}</h4>`;
        default: return `<p>${children}</p>`;
      }
    }
    return '';
  }).join('');
}
---

<Layout title="Research | Sheehan Lab">
  <main>
    <section class="page-header">
      <div class="container">
        <h1>Our Research</h1>
        <p>The Sheehan Lab is dedicated to advancing understanding and treatment of sickle cell disease through innovative approaches. Our research spans multiple areas including HbF induction, xenograft models, gene editing, alloimmunization, and microfluidics, all aimed at improving patient outcomes.</p>
      </div>
    </section>

    {error ? (
      <section class="error-section">
        <div class="container">
          <div class="error-message">
            <h2>üîß Unable to load research data</h2>
            <p>Please ensure the Sanity CMS is properly configured.</p>
            <details>
              <summary>Technical details</summary>
              <p>{error}</p>
            </details>
          </div>
        </div>
      </section>
    ) : researchAreas.length === 0 ? (
      <section class="empty-section">
        <div class="container">
          <div class="empty-message">
            <h2>üìù No research areas found</h2>
            <p>Add research areas through the Sanity Studio to see them here.</p>
          </div>
        </div>
      </section>
    ) : (
      <div class="research-nav-wrapper">
        <aside class="research-nav">
          <nav>
            <ul>
              {researchAreas.map((area) => (
                <li><a href={`#${area.slug.current}`}>{area.title}</a></li>
              ))}
            </ul>
          </nav>
        </aside>

        <div class="research-content-wrapper">
          {researchAreas.map((area, index) => (
            <>
              {index > 0 && <div class="section-divider"></div>}
              <section id={area.slug.current} class={`research-area ${index % 2 === 1 ? 'alternate' : ''}`}>
                <div class="container">
                  <div class="research-content">
                    <div class="text-content">
                      <h2>{area.title}</h2>
                      {area.summary && <p class="summary">{area.summary}</p>}
                      
                      {area.description && (
                        <div class="description" set:html={renderPortableText(area.description)} />
                      )}
                      
                      {area.highlights && area.highlights.length > 0 && (
                        <div>
                          <p>Key findings from our research include:</p>
                          <ul class="research-highlights">
                            {area.highlights.map((highlight) => (
                              <li>{highlight}</li>
                            ))}
                          </ul>
                        </div>
                      )}
                    </div>
                    
                    <div class="image-gallery">
                      {area.primaryImage && (
                        <div class="image-container primary-image">
                          <img 
                            src={urlFor(area.primaryImage).width(600).height(400).quality(85).url()} 
                            alt={area.title}
                            loading="lazy"
                          />
                        </div>
                      )}
                      {area.secondaryImage && (
                        <div class="image-container secondary-image">
                          <img 
                            src={urlFor(area.secondaryImage).width(400).height(300).quality(85).url()} 
                            alt={`${area.title} - Additional`}
                            loading="lazy"
                          />
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </section>
            </>
          ))}
        </div>
      </div>
    )}
  </main>

  <style>
    .page-header {
      background: var(--emory-primary);
      color: white;
      padding: 4rem 0 2.5rem;
      margin-top: 60px;
      text-align: center;
      position: relative;
    }

    .page-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    .page-header h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: white;
      position: relative;
      z-index: 1;
    }

    .page-header p {
      color: rgba(255, 255, 255, 0.9);
      position: relative;
      z-index: 1;
      max-width: 800px;
      margin: 0 auto;
      font-size: 1rem;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.25rem;
    }

    .error-section, .empty-section {
      padding: 4rem 0;
      background: #f8fafc;
    }

    .error-message, .empty-message {
      background: white;
      border-radius: 12px;
      padding: 3rem;
      text-align: center;
      box-shadow: 0 2px 12px rgba(0, 33, 105, 0.06);
    }

    .research-nav-wrapper {
      display: flex;
      position: relative;
    }

    .research-nav {
      position: sticky;
      top: 80px;
      height: fit-content;
      width: 250px;
      background: white;
      border-right: 1px solid #e2e8f0;
      padding: 2rem 0;
    }

    .research-nav nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .research-nav nav li {
      margin-bottom: 0.5rem;
    }

    .research-nav nav a {
      display: block;
      padding: 0.75rem 1.5rem;
      color: #4a5568;
      text-decoration: none;
      border-left: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .research-nav nav a:hover {
      background: #f7fafc;
      border-left-color: var(--emory-secondary);
      color: var(--emory-primary);
    }

    .research-content-wrapper {
      flex: 1;
      width: 100%;
    }

    .section-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
      margin: 0 2rem;
    }

    .research-area {
      padding: 4rem 0;
      background: white;
    }

    .research-area.alternate {
      background: #f8fafc;
    }

    .research-content {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 3rem;
      align-items: start;
    }

    .text-content h2 {
      font-size: 2.25rem;
      color: var(--emory-primary);
      margin-bottom: 1.5rem;
      position: relative;
    }

    .summary {
      font-size: 1.1rem;
      color: #4a5568;
      margin-bottom: 1.5rem;
      font-weight: 500;
    }

    .description {
      color: #4a5568;
      line-height: 1.7;
      margin-bottom: 1.5rem;
    }

    .description p {
      margin-bottom: 1rem;
    }

    .description h3 {
      color: var(--emory-primary);
      margin: 1.5rem 0 1rem;
    }

    .description h4 {
      color: var(--emory-secondary);
      margin: 1rem 0 0.5rem;
    }

    .research-highlights {
      background: #f7fafc;
      border-left: 4px solid var(--emory-secondary);
      padding: 1.5rem;
      margin: 1.5rem 0;
      border-radius: 0 8px 8px 0;
    }

    .research-highlights li {
      margin-bottom: 0.75rem;
      color: #4a5568;
      line-height: 1.6;
    }

    .research-highlights li:last-child {
      margin-bottom: 0;
    }

    .image-gallery {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .image-container {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 33, 105, 0.1);
    }

    .image-container img {
      width: 100%;
      height: auto;
      display: block;
      transition: transform 0.3s ease;
    }

    .image-container:hover img {
      transform: scale(1.02);
    }

    .primary-image {
      aspect-ratio: 3/2;
    }

    .secondary-image {
      aspect-ratio: 4/3;
    }

    @media (max-width: 1024px) {
      .research-nav-wrapper {
        flex-direction: column;
      }

      .research-nav {
        position: static;
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #e2e8f0;
        padding: 1rem 0;
      }

      .research-nav nav {
        overflow-x: auto;
      }

      .research-nav nav ul {
        display: flex;
        gap: 1rem;
        padding: 0 1rem;
        white-space: nowrap;
      }

      .research-nav nav li {
        margin-bottom: 0;
      }

      .research-content {
        grid-template-columns: 1fr;
        gap: 2rem;
      }

      .image-gallery {
        flex-direction: row;
        overflow-x: auto;
        padding-bottom: 1rem;
      }

      .image-container {
        flex-shrink: 0;
        width: 250px;
      }
    }

    @media (max-width: 768px) {
      .page-header {
        padding: 3rem 0 2rem;
      }

      .page-header h1 {
        font-size: 2rem;
      }

      .research-area {
        padding: 3rem 0;
      }

      .text-content h2 {
        font-size: 1.75rem;
      }

      .image-gallery {
        flex-direction: column;
      }

      .image-container {
        width: 100%;
      }
    }

    details {
      margin-top: 1rem;
    }

    summary {
      cursor: pointer;
      color: var(--emory-secondary);
    }

    details p {
      margin-top: 0.5rem;
      padding: 1rem;
      background: #f7fafc;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.9rem;
    }
  </style>
</Layout> 